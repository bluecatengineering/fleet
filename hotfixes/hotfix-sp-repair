#!/bin/bash -u
#
# hotfix sp-repair
# hotfix to repair SP 4.5.x systems
#
# usage: ssh [SSH_ARGS] <service-point> sudo -E env "PATH=$PATH:/opt/bluecat/bin/" hotfix sp-repair

export PATH=$PATH:/opt/bluecat/bin:/usr/sbin

cleanVolumes() {
	fleet res | grep volumes
	snapshots=`lvs -S 'lv_attr =~ ^s && lv_name =~ [^snap-]' -o lv_name --no-headings`
	for snapshot in $snapshots; do
		lvremove -f sdp/$snapshot
	done

	. /root/.bashrc
	cd /svcVols || exit 0
	clean=true
	for volume in *; do
		jobStatus=`nomad status $volume 2>&1 | head -1`
		case $jobStatus in
		Unable*)
			service-volume delete $volume
			clean=false
			;;
		esac
	done
		fleet res | grep volumes
}

cleanLogs() {
	# clean up large fluentbit databases
	dbtop=/var/lib/sdp/fluentbit

	clean=true
	cd  $dbtop || exit 1
	du -sh $dbtop
	for dbdir in *; do
		filesCount=`ls -1 $dbdir | wc -l`
		if test $filesCount -gt 100; then
			echo found $filesCount files in $dbdir
			rm -rf $dbdir
			clean=false
		fi
	done

	if test $clean = false; then
		echo restarting fluentbit
		systemctl restart fluentbit
		systemctl status fluentbit
	fi

	cd /var/log || exit 1
	for file in syslog* daemon.log*; do
		cp /dev/null $file
	done

	du -sh $dbtop
	df -h /var
}

repairBSLServices() {
	echo running repairBSLServices

	 # BSLD Version Map
    bsld_version_450="0.2.4-build.327491-e1163ff8"
    bsld_version_451="0.2.4-build.341384-579b13f7"
    bsld_version_460="0.2.4-build.371117-df002ae9"

    # BSLC Version Map
    bslc_version_450="0.2.4-build.323884-63ac0d26"
    bslc_version_451="0.2.4-build.323884-63ac0d26"
    bslc_version_460="0.2.4-build.371214-346712cc"

    bslc_wait_interval="30"

    installed_bsld_version=$(apt list --installed 2> /dev/null | grep sdp-bsld | cut -d ' ' -f2)
    installed_bslc_version=$(docker inspect bslc:local | jq -r '.[].Config.Labels["com.bluecatnetworks.build"]')
    management_endpoint=$(jq ".managementHttpsEndpoint" --raw-output /opt/bluecat/bsld/conf/node.conf)

    if [[ $current == "v4.5.0" ]]; then
        bsld_target_version="$bsld_version_450"
        bslc_target_version="$bslc_version_450"
    elif [[ $current == "v4.5.1" ]]; then
        bsld_target_version="$bsld_version_451"
        bslc_target_version="$bslc_version_451"
    else
        echo "Service Point version is $current. Skipping version specific sanitzation..."
        exit 0
    fi

    echo "BSLD version $installed_bsld_version found"
    if [[ $installed_bsld_version != $bsld_target_version ]]; then
        echo "Reinstalling BSLD to version $bsld_target_version"

        apt update && apt install -y --allow-downgrades sdp-bsld=$bsld_target_version
        systemctl restart bsld
        systemctl restart telemetry-api
    fi

    echo "BSLC version $installed_bslc_version found"
    if [[ $installed_bslc_version != $bslc_target_version ]]; then
        echo "Reinstalling BSLC to version $bslc_target_version"

        docker tag bslc:local bslc:backup
        docker pull "$management_endpoint:443/library/bslc:$bslc_target_version"
        docker tag "$management_endpoint:443/library/bslc:$bslc_target_version" bslc:local

        echo "Restarting BSLC. Waiting for $bslc_wait_interval seconds..."
        docker kill "$(docker ps | grep bslc | cut -d' ' -f 1)"
        sleep $bslc_wait_interval

        docker rmi bslc:backup
        docker rmi "$management_endpoint:443/library/bslc:$bslc_target_version"
    fi

	# Verify installation
	installed_bsld_version=$(apt list --installed 2> /dev/null | grep sdp-bsld | cut -d ' ' -f2)
    installed_bslc_version=$(docker inspect bslc:local | jq -r '.[].Config.Labels["com.bluecatnetworks.build"]')

	if [[ $installed_bsld_version != $bsld_target_version || $installed_bslc_version != $bslc_target_version  ]]; then
		echo "Expected SDP Packages are not installed on the system"
		echo "SP Version: $current"
		echo "BSLD Version: $installed_bsld_version"
		echo "BSLC Version: $installed_bsld_version"
		exit 1
	fi
}

runHotfixSteps() {
	current=`fleet version`
	case $current in
	v4.5*|v4.6*)
		echo correct SP platform version $current
		cleanVolumes
		cleanLogs
		repairBSLServices
		;;
	*)
		echo wrong SP platform version, expected 4.5.x but got $current
		exit 1
	esac
}

runHotfixSteps
