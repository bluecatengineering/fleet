#!/bin/bash -u
#
# hotfix2 - hotfix to patch bsld on small ENCS systems

verifyPlatform() {
	if test `fleet size` != small; then
		echo wrong platform size
		exit 1
	fi
}

patchBSLD() {
	package=sdp-bsld-0.2.4-build.325876-80f0edc0.deb
	packageFullPath=$hotfixDir/$package
	echo downloading BSLD
	with-proxy curl -s $hotfixRaw/$package > $packageFullPath
	if ! test -s $packageFullPath; then
		echo failed to download $hotfixRaw/$package
		exit 1
	fi

	echo patching BSLD
	dpkg -i $packageFullPath
	echo restarting BSLD
	systemctl restart bsld
	echo waiting for BSLD to become healthy
	sleep 2
	status=`curl -s -m 1 -w "%{http_code}" http://localhost:8082/api/v1/health`
	while test "$status" != 200; do
		echo status is $status, checking in 5 seconds
		sleep 5
		status=`curl -s -m 1 -w "%{http_code}" http://localhost:8082/api/v1/health`
	done
	echo status is $status, BSLD is healthy
}

# remove the hotfix so it will get re-downloaded each time for dev testing
rm -f $hotfixFullPath

verifyPlatform
patchBSLD
